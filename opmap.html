<html>
<head>
  <title></title>
  <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="http://maps.google.com/maps/api/js?sensor=true"></script>
  <script src="gmaps.js"></script>
  <style type="text/css">
    #map {
      width: 100%;
      height: 100%;
   }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    var map;

    function loadResults (items) {
      var items, markers_data = [];
      if (items.length > 0) {
        var pathname = window.location.pathname;
        var path = pathname.substring(0, pathname.lastIndexOf('/'));
        var icon = 'http://' + window.location.hostname + path + '/radioicon.png';

        for (var i = 0; i < items.length; i++) {
          var item = items[i];

          if (item.lat != undefined && item.lon != undefined) {
            
            markers_data.push({
              lat : item.lat,
              lng : item.lon,
              title : item.callsign,
              icon : {
                size : new google.maps.Size(32, 32),
                url : icon
              }
            });
          }
        }
      }
	
      map.removeMarkers();
      map.addMarkers(markers_data);
    }

    $(document).ready(function(){

      function updatePoints(e) {
        var bounds = map.getBounds();
        if (map.getBounds() === undefined) {
          alert("undefBBox");
        } else {
          var sw = bounds.getSouthWest();
          var ne = bounds.getNorthEast();
          var query = 'http://' + window.location.hostname + ':8080/operators?minLat=' + sw.lat() + '&minLon=' + sw.lng() + '&maxLon=' + ne.lng() + '&maxLat=' + ne.lat();
          var xhr = $.getJSON(query);
          xhr.done(loadResults);
        }
      }

      map = new GMaps({
        div: '#map',
        lat: 38.9,
        lng: -94.7,
        idle: function(e) {
          updatePoints(e);
        }
      });

    });

  </script>
</body>
</html>

